#!/usr/bin/env python
# -*- python -*-
#
# Remove an eups product from the system
#
import os, re, sys
import shutil
import eups
    
#-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
#
# Deal with arguments
#
options = {
    "-C" : (False, "--check", "Check that recursively removed products aren'r needed (very slow!)"),
    "-F" : (False, "--force", "Force requested behaviour (e.g. redeclare a product)"),
    "-f" : (True,  "--flavor", "Use this flavor. Default: $EUPS_FLAVOR or `eups_flavor`"),
    "-h" : (False, "--help", "Print this help message"),
    "-n" : (False, "--noaction", "Don\'t actually do anything"),
    "-R" : (False, "--recursive", "Recursively also remove everything that this product depends on"),
    "-v" : (False, "--verbose", "Be chattier (repeat for even more chat)"),
    "-Z" : (True,  "--database", "Use this products path. Default: $EUPS_PATH"),
    "-z" : (True,  "--select-db", "Select the product paths which contain this directory.\nDefault: all"),
    }
aliases = {}

try:
    opts = eups.Getopt(options, sys.argv, aliases, "eups_remove [options] product version")
except RuntimeError, param:
    print >> sys.stderr, "Error parsing arguments: %s" % param
    sys.exit(1)

if opts.has_option('-h'):
    print >> sys.stderr, "Remove an eups product from the system\n"
    opts.usage()
    sys.exit(0)

check = opts.has_option('-C')

force = opts.has_option('-F')

if opts.has_option('-f'):
    flavor = opts.options['-f']
else:
    flavor = eups.flavor()

noaction = opts.has_option('-n')

recursive = opts.has_option('-R')

verbose = 0
if opts.has_option('-v'):
    verbose = opts.options['-v']

#
# Figure out which database to use
#
if opts.has_option('-Z'):
    eups.setPath(opts.options['-Z'])

dbz = ""
if opts.has_option('-z'):
    dbz = opts.options['-z']

try:
    eups_path = eups.path()
    db = eups.selectPathComponent(dbz)
except RuntimeError, e:
    print >> sys.stderr, e
    sys.exit(1)

if len(opts.argv) == 0:
    print >> sys.stderr, "Please specify a product and version"
    sys.exit(1)    
if len(opts.argv) == 1:
    print >> sys.stderr, "Please specify a version to remove"
    sys.exit(1)    
    
product, version = opts.argv[0:2]

if len(opts.argv) > 2:
    print >> sys.stderr, "Junk at end of arguments:", " ".join(opts.argv[2:])
    sys.exit(1)    
#
# Do the work
#
try:
    eups.remove(product, version, flavor, dbz, recursive, force, check, noaction)
except RuntimeError, e:
    print >> sys.stderr, e
    sys.exit(1)
