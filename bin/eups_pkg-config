#!/bin/sh
#
# Run pkg-config for a product that's set up
#
if [ X"$1" = X"-h" -o X"$1" = X"--help" ]; then
   cat >&2 <<EOF
Run pkg-config on a product that's currently setup
Usage:
	eups pkg-config product [options]

All pkg-config options are passed through:
EOF
   pkg-config --usage
   exit 1
fi

if [ X"$1" = X"" ];then
   echo "Please specify a product" >&2
   exit 1
fi

product=$1; shift
product_dir=$(eups list --directory --setup $product 2> /dev/null | head -1)
if [ X"$product_dir" = X"" ]; then
   echo "product $product is not setup" >&2
   exit 1
fi
#
# Add product_dir to PKG_CONFIG_PATH
#
if [ X"$PKG_CONFIG_PATH" = X"" ]; then
    PKG_CONFIG_PATH=$product_dir/etc
else
    PKG_CONFIG_PATH=$PKG_CONFIG_PATH:$product_dir/etc
fi
#
# Are there any requirements?  If so, add them to PKG_CONFIG_PATH too
#
pcfile=$product_dir/etc/$product.pc
if [ -f $pcfile ]; then
    for extraProduct in $(perl -ne 'if(s/^Requires:\s+//) { print }' $pcfile); do
	extraProduct_dir=$(eups list --directory --setup $extraProduct 2> /dev/null | head -1)
	if [ X"$extraProduct_dir" = X"" ]; then
	    echo "product $extraProduct is not setup" >&2
	else
	    PKG_CONFIG_PATH=$PKG_CONFIG_PATH:$extraProduct_dir/etc
	fi
    done
fi
export PKG_CONFIG_PATH
#
# The sed works around an old bug in pkg-config
# I filed a Debian bug report (378570) and it's fixed in the next release, 0.21-1
#
pkg-config $product "$@" | sed -e 's/%/$/g'

